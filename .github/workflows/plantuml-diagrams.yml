name: Render PlantUML Diagrams

on:
  push:
    paths:
      - '**/*.md'
      - '.github/workflows/plantuml-diagrams.yml'
      - '.github/scripts/render_plantuml.sh'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  render-plantuml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      - name: Debug git status after checkout
        run: |
          git status
          git diff

      - name: Reset any unstaged changes
        run: git reset --hard

      - name: Pull latest changes with rebase
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git pull --rebase origin main

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull PlantUML Docker image
        run: docker pull plantuml/plantuml

      - name: Make render script executable
        run: chmod +x .github/scripts/render_plantuml.sh

      - name: Clean up existing broken diagrams directory
        run: |
          echo "Cleaning up any existing nested diagrams directories..."
          find . -path "*/diagrams/documentation" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "diagrams" -type d -exec sh -c 'echo "Found diagrams dir: $1"; ls -la "$1"' _ {} \;

      - name: Render PlantUML diagrams
        run: .github/scripts/render_plantuml.sh

      - name: Debug - Show generated files
        run: |
          echo "=== Generated diagrams ==="
          find . -name "diagrams" -type d -exec sh -c 'echo "Directory: $1"; ls -la "$1"' _ {} \;
          echo "=== All PNG files ==="
          find . -name "*.png" -type f

      - name: Show git status for debug
        run: |
          git status
          git diff --stat

      - name: Auto-commit rendered diagrams
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generate PlantUML diagrams for CritterDeterrenceSystem"
          add_options: -A
          file_pattern: .
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: dlandi <3196088+dlandi@users.noreply.github.com>